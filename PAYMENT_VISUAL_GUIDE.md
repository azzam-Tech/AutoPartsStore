# ?? PAYMENT SYSTEM - VISUAL GUIDE

## Payment Flow Diagrams

---

## 1. Credit Card Payment (with OTP)

```
??????????????????????????????????????????????????????????????????????
? CREDIT CARD PAYMENT FLOW (with 3D Secure / OTP)                   ?
??????????????????????????????????????????????????????????????????????

    USER                 FRONTEND              BACKEND         MOYASAR
     ?                      ?                     ?               ?
     ?  1. Fill Card Form   ?                     ?               ?
     ??????????????????????>?                     ?               ?
     ?  • Card Number       ?                     ?               ?
     ?  • Name              ?                     ?               ?
     ?  • Expiry            ?                     ?               ?
     ?  • CVC               ?                     ?               ?
     ?                      ?                     ?               ?
     ?                      ?  2. POST /initiate  ?               ?
     ?                      ?????????????????????>?               ?
     ?                      ?  {                  ?               ?
     ?                      ?    cardNumber,      ?               ?
     ?                      ?    cardHolder,      ?               ?
     ?                      ?    expiry,          ?               ?
     ?                      ?    cvc              ?               ?
     ?                      ?  }                  ?               ?
     ?                      ?                     ?               ?
     ?                      ?                     ? 3. Create     ?
     ?                      ?                     ?   Payment     ?
     ?                      ?                     ???????????????>?
     ?                      ?                     ?               ?
     ?                      ?                     ? 4. Transaction?
     ?                      ?                     ?    URL        ?
     ?                      ?                     ?<???????????????
     ?                      ?                     ?               ?
     ?                      ? 5. Redirect URL     ?               ?
     ?                      ?<?????????????????????               ?
     ?                      ?                     ?               ?
     ?  6. Redirect         ?                     ?               ?
     ?<??????????????????????                     ?               ?
     ?                      ?                     ?               ?
     ?                                                             ?
     ?  7. 3D SECURE PAGE (on Moyasar website)                    ?
     ?????????????????????????????????????????????????????????????>?
     ?                                                             ?
     ?  ????????????????????????????????????????????????????????  ?
     ?  ? ?? 3D Secure Verification                           ?  ?
     ?  ?                                                      ?  ?
     ?  ? A verification code has been sent to               ?  ?
     ?  ? your phone ending in ××××1234                      ?  ?
     ?  ?                                                      ?  ?
     ?  ? Enter code: [____][____][____][____][____][____]   ?  ?
     ?  ?                                                      ?  ?
     ?  ?                    [Verify]                         ?  ?
     ?  ????????????????????????????????????????????????????????  ?
     ?                                                             ?
     ?  8. Enter OTP: 123456                                       ?
     ?????????????????????????????????????????????????????????????>?
     ?                                                             ?
     ?                                             9. Verify OTP   ?
     ?                                             10. Process     ?
     ?                                                 Payment     ?
     ?                                                             ?
     ?                                            11. Callback     ?
     ?                              POST /callback  <???????????????
     ?                              { paymentId }                  ?
     ?                                     ?                       ?
     ?                      12. Fetch Payment                      ?
     ?                         Status                              ?
     ?                                     ???????????????>????????>?
     ?                                     ?                       ?
     ?                                     ? 13. Status: PAID      ?
     ?                                     ?<???????????????????????
     ?                                     ?                       ?
     ?                      14. Update Order Status                ?
     ?                          • Payment ? Paid                   ?
     ?                          • Order ? Paid                     ?
     ?                          • Reduce Stock                     ?
     ?                                                             ?
     ?  15. Redirect Back                                          ?
     ?<??????????????????????????????????????????????????????????  ?
     ?                      ?                     ?               ?
     ?  16. Show Success    ?                     ?               ?
     ?<??????????????????????                     ?               ?
     ?                      ?                     ?               ?
     ?  ? PAYMENT         ?                     ?               ?
     ?     COMPLETE!        ?                     ?               ?
     ?  (Total: ~30 sec)    ?                     ?               ?
     ?                      ?                     ?               ?

```

---

## 2. Apple Pay Payment (no OTP)

```
??????????????????????????????????????????????????????????????????????
? APPLE PAY PAYMENT FLOW (Instant - no OTP)                         ?
??????????????????????????????????????????????????????????????????????

    USER                 FRONTEND              BACKEND         MOYASAR
     ?                      ?                     ?               ?
     ?  1. Click Apple Pay  ?                     ?               ?
     ??????????????????????>?                     ?               ?
     ?                      ?                     ?               ?
     ?                      ? 2. Init Apple Pay   ?               ?
     ?                      ?    Session          ?               ?
     ?                      ?                     ?               ?
     ?  3. Show Apple Pay   ?                     ?               ?
     ?     Dialog           ?                     ?               ?
     ?<??????????????????????                     ?               ?
     ?                      ?                     ?               ?
     ?  ??????????????????????????????????????    ?               ?
     ?  ? ?? Apple Pay                      ?    ?               ?
     ?  ?                                    ?    ?               ?
     ?  ? Pay 2,305.00 SAR                  ?    ?               ?
     ?  ? with Visa ••••1234                ?    ?               ?
     ?  ?                                    ?    ?               ?
     ?  ? Double-click to pay with Face ID  ?    ?               ?
     ?  ?                                    ?    ?               ?
     ?  ?            ??                     ?    ?               ?
     ?  ?         (Face ID)                 ?    ?               ?
     ?  ?                                    ?    ?               ?
     ?  ??????????????????????????????????????    ?               ?
     ?                      ?                     ?               ?
     ?  4. Face ID /        ?                     ?               ?
     ?     Touch ID         ?                     ?               ?
     ?     Authentication   ?                     ?               ?
     ?                      ?                     ?               ?
     ?  5. Approve ?       ?                     ?               ?
     ??????????????????????>?                     ?               ?
     ?                      ?                     ?               ?
     ?                      ? 6. Get Token        ?               ?
     ?                      ?    from Apple       ?               ?
     ?                      ?                     ?               ?
     ?                      ? 7. POST /initiate   ?               ?
     ?                      ?????????????????????>?               ?
     ?                      ?  {                  ?               ?
     ?                      ?    paymentMethod:   ?               ?
     ?                      ?      "ApplePay",    ?               ?
     ?                      ?    applePayToken:   ?               ?
     ?                      ?      "<token>"      ?               ?
     ?                      ?  }                  ?               ?
     ?                      ?                     ?               ?
     ?                      ?                     ? 8. Process    ?
     ?                      ?                     ?    Payment    ?
     ?                      ?                     ???????????????>?
     ?                      ?                     ?               ?
     ?                      ?                     ? 9. INSTANT    ?
     ?                      ?                     ?    APPROVAL   ?
     ?                      ?                     ?               ?
     ?                      ?                     ? 10. Status:   ?
     ?                      ?                     ?     PAID      ?
     ?                      ?                     ?<???????????????
     ?                      ?                     ?               ?
     ?                      ? 11. Success         ?               ?
     ?                      ?<?????????????????????               ?
     ?                      ?                     ?               ?
     ?  12. Show Success ? ?                     ?               ?
     ?<??????????????????????                     ?               ?
     ?                      ?                     ?               ?
     ?  ? PAYMENT         ?                     ?               ?
     ?     COMPLETE!        ?                     ?               ?
     ?  (Total: ~5 sec)     ?                     ?               ?
     ?                      ?                     ?               ?

```

---

## 3. Comparison Chart

```
????????????????????????????????????????????????????????????????
? CREDIT CARD vs APPLE PAY                                     ?
????????????????????????????????????????????????????????????????

CREDIT CARD                        APPLE PAY
???????????????????????????????    ????????????????????????????
                                   
1. Enter card details              1. Click button
   ??  ~10 seconds                    ??  ~1 second
   
2. Submit form                     2. Face ID / Touch ID
   ??  ~2 seconds                     ??  ~2 seconds
   
3. Redirect to Moyasar             3. Token generated
   ??  ~3 seconds                     ??  ~1 second
   
4. Show OTP page                   4. Payment processed
   ??  ~2 seconds                     ??  ~1 second
   
5. Wait for SMS                    ? DONE!
   ??  ~5 seconds                     
   
6. Enter OTP code                  
   ??  ~5 seconds                  
   
7. Verify OTP                      
   ??  ~2 seconds                  
   
8. Process payment                 
   ??  ~1 second                   
   
? DONE!                           

TOTAL: ~30 seconds                 TOTAL: ~5 seconds
STEPS: 8                           STEPS: 4
OTP: ? Required                   OTP: ? Not needed

```

---

## 4. Security Comparison

```
????????????????????????????????????????????????????????????????
? SECURITY LAYERS                                              ?
????????????????????????????????????????????????????????????????

CREDIT CARD (3D Secure)           APPLE PAY
???????????????????????????????    ????????????????????????????

?? Layer 1: HTTPS                  ?? Layer 1: HTTPS
    • SSL/TLS encryption               • SSL/TLS encryption
    
?? Layer 2: Card Validation        ?? Layer 2: Device Security
    • Luhn algorithm                   • Secure Enclave
    • CVC verification                 • Hardware encryption
    
?? Layer 3: 3D Secure              ?? Layer 3: Biometric Auth
    • Bank authentication              • Face ID
    • SMS OTP                          • Touch ID
    • Challenge-response               • No password needed
    
?? Layer 4: Moyasar Gateway        ?? Layer 4: Token Based
    • PCI DSS compliant                • No card data exposed
    • Fraud detection                  • Dynamic tokens
    • Risk analysis                    • One-time use
    
?? Layer 5: Backend Validation     ?? Layer 5: Backend Validation
    • JWT authentication               • JWT authentication
    • Amount verification              • Amount verification
    • Idempotency check               • Idempotency check

SECURITY LEVEL: ????? High     SECURITY LEVEL: ????? High
CONVENIENCE: ??? Medium          CONVENIENCE: ????? Excellent

```

---

## 5. User Experience Flow

```
????????????????????????????????????????????????????????????????
? USER JOURNEY                                                 ?
????????????????????????????????????????????????????????????????

CREDIT CARD PATH                   APPLE PAY PATH
???????????????????????????????    ????????????????????????????

?? Cart                            ?? Cart
  ??> Checkout                       ??> Checkout
       ??> Select Payment Method          ??> Select Payment Method
            ??> ?? Credit Card                 ??> ?? Apple Pay
                 ??> Enter Details                  ??> Double-click Face ID
                      ?? Card Number                      ??> ? PAID!
                      ?? Name                                  ??> Confirmation
                      ?? Expiry                                     ??> ?? Done!
                      ?? CVC
                           ??> Submit
                                ??> ?? Redirect to Moyasar
                                     ??> ?? Check Phone
                                          ??> ?? SMS Received
                                               ??> Enter OTP
                                                    ??> ? PAID!
                                                         ??> ?? Redirect Back
                                                              ??> Confirmation
                                                                   ??> ?? Done!

??  TOTAL TIME: ~30 seconds        ??  TOTAL TIME: ~5 seconds
?? INTERACTIONS: 8                 ?? INTERACTIONS: 3
?? AUTH METHOD: SMS OTP            ?? AUTH METHOD: Biometric

SATISFACTION: ???? Good         SATISFACTION: ????? Excellent

```

---

## 6. Payment Status Diagram

```
????????????????????????????????????????????????????????????????
? PAYMENT STATUS FLOW                                          ?
????????????????????????????????????????????????????????????????

                        ???????????????
                        ?  INITIATED  ?
                        ???????????????
                               ?
                    ????????????????????????
                    ?                      ?
              ?????????????          ????????????
              ?  PENDING  ?          ?  FAILED  ? ?
              ?????????????          ????????????
                    ?
         ???????????????????????
         ?                     ?
    ???????????          ????????????
    ?  PAID   ? ?       ?AUTHORIZED?
    ???????????          ????????????
         ?                    ?
         ?              ?????????????
         ?              ? CAPTURED  ? ?
         ?              ?????????????
         ?                    ?
         ??????????????????????
                  ?
         ???????????????????
         ?                 ?
    ????????????     ?????????????????
    ?REFUNDED  ?     ?PARTIALLY      ?
    ?          ?     ?REFUNDED       ?
    ????????????     ?????????????????

STATUS MEANINGS:
???????????????
INITIATED    - Payment created
PENDING      - Processing (OTP sent)
PAID         - ? Successfully paid
AUTHORIZED   - Authorized (not captured yet)
CAPTURED     - ? Money captured
FAILED       - ? Payment failed
REFUNDED     - Money returned (full)
PARTIALLY    - Money returned (partial)
  REFUNDED

```

---

## 7. Error Handling Flow

```
????????????????????????????????????????????????????????????????
? ERROR SCENARIOS                                              ?
????????????????????????????????????????????????????????????????

CREDIT CARD ERRORS                 APPLE PAY ERRORS
???????????????????????????????    ????????????????????????????

? Invalid Card Number             ? Face ID Failed
   ??> Show: "ÑÞã ÇáÈØÇÞÉ ÎÇØÆ"      ??> Show: "Try again"
        ??> Allow retry                   ??> Allow retry

? Expired Card                    ? User Cancelled
   ??> Show: "ÈØÇÞÉ ãäÊåíÉ"          ??> Back to payment page
        ??> Update card                  ??> Try different method

? Insufficient Funds              ? Device Not Supported
   ??> Show: "ÑÕíÏ ÛíÑ ßÇÝò"         ??> Hide Apple Pay button
        ??> Try different card           ??> Show other methods

? Wrong OTP Code                  ? Network Error
   ??> Show: "ÑãÒ ÎÇØÆ"               ??> Show: "Connection issue"
        ??> Resend OTP                   ??> Retry button
             ??> Try again

? OTP Timeout                     ? Token Invalid
   ??> Show: "ÇäÊåÊ ÇáãåáÉ"           ??> Restart Apple Pay
        ??> Start over                   ??> Generate new token

? 3D Secure Failed                
   ??> Show: "ÝÔá ÇáÊÍÞÞ"            
        ??> Contact bank              

```

---

## 8. System Architecture

```
????????????????????????????????????????????????????????????????
? PAYMENT ARCHITECTURE                                         ?
????????????????????????????????????????????????????????????????

    ???????????????
    ?   BROWSER   ?
    ?  (Frontend) ?
    ???????????????
           ? HTTPS
           ? JWT Token
           ?
    ???????????????????????
    ?  API CONTROLLERS    ?
    ?  PaymentsController ?
    ???????????????????????
           ?
    ???????????????????????
    ?  PAYMENT SERVICE    ?
    ?  • InitiatePayment  ?
    ?  • ProcessCallback  ?
    ?  • VerifyPayment    ?
    ?  • RefundPayment    ?
    ???????????????????????
           ?
    ???????????????????????
    ?  MOYASAR SERVICE    ?
    ?  • CreatePayment    ?
    ?  • GetPayment       ?
    ?  • RefundPayment    ?
    ???????????????????????
           ? HTTPS
           ? Basic Auth
           ?
    ???????????????????????
    ?  MOYASAR API        ?
    ?  (Payment Gateway)  ?
    ???????????????????????
           ?
    ???????????????????????
    ?  BANK / CARD        ?
    ?  NETWORK            ?
    ?  • Visa             ?
    ?  • MasterCard       ?
    ?  • Mada             ?
    ?  • Apple Pay        ?
    ???????????????????????

DATA FLOW:
??????????
1. User ? Frontend: Card details
2. Frontend ? Backend: Payment request
3. Backend ? Moyasar: Create payment
4. Moyasar ? Bank: Process payment
5. Bank ? Moyasar: Payment result
6. Moyasar ? Backend: Callback
7. Backend ? Database: Update status
8. Backend ? Frontend: Payment status
9. Frontend ? User: Show result

```

---

## 9. Timeline Comparison

```
????????????????????????????????????????????????????????????????
? TIME COMPARISON                                              ?
????????????????????????????????????????????????????????????????

CREDIT CARD TIMELINE (30 seconds)
?????????????????????????????????
0s  ????????????????????> Enter card details
10s ????????> Submit form
12s ??> Redirect to Moyasar
15s ??????> Show OTP page
20s ??????????????> Wait for SMS
25s ??????> Enter OTP
27s ??> Verify OTP
28s ??> Process payment
30s ??> ? PAID!

APPLE PAY TIMELINE (5 seconds)
???????????????????????????????
0s  ????> Click Apple Pay
1s  ??> Show Face ID
3s  ??> Authenticate
4s  ??> Generate token & process
5s  ??> ? PAID!

SPEED DIFFERENCE: 6x FASTER with Apple Pay!

```

---

## 10. Decision Tree

```
????????????????????????????????????????????????????????????????
? PAYMENT METHOD SELECTOR                                      ?
????????????????????????????????????????????????????????????????

                     Need to Pay?
                          ?
              ?????????????????????????
              ?                       ?
         Have iPhone?              No iPhone
              ?                       ?
         ???????????              Use Credit
         ? Apple   ?              Card/Mada
         ? Pay OK? ?                  ?
         ???????????              ??????????
              ?                   ? Enter  ?
         ???????????              ? Card   ?
         ? YES ?  ?              ?Details ?
         ?         ?              ??????????
         ? Face ID ?                  ?
         ?   ?     ?              ??????????
         ? ~5 sec  ?              ? Submit ?
         ?   ?     ?              ??????????
         ? PAID! ??                  ?
         ???????????              ???????????
                                  ? Redirect?
                                  ? Moyasar ?
                                  ???????????
                                      ?
                                  ??????????
                                  ? Enter  ?
                                  ?  OTP   ?
                                  ??????????
                                      ?
                                  ??????????
                                  ? ~30sec ?
                                  ?   ?    ?
                                  ? PAID!??
                                  ??????????

RECOMMENDATION:
???????????????
iOS Users ? Apple Pay (Faster, Easier)
Others    ? Credit Card (Works everywhere)

```

---

**Status:** ?? **Visual Reference Complete**  
**Last Updated:** January 2025
